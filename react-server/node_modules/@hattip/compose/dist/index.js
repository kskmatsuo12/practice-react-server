// src/index.ts
function finalHandler(context) {
  context.passThrough();
  return new Response("Not found", { status: 404 });
}
function composePartial(handlers, next) {
  const flatHandlers = handlers.flat().filter(Boolean);
  return flatHandlers.map(wrap).reduceRight(
    (prev, current) => {
      return async (context) => {
        context.next = () => prev(context);
        const result = await current(context);
        return result || prev(context);
      };
    },
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    next ? (_) => next() : (_) => void 0
  );
}
function compose(...handlers) {
  return composePartial([
    (context) => {
      context.url = new URL(context.request.url);
      context.method = context.request.method;
      context.locals = {};
      context.handleError = (error) => {
        console.error(error);
        return new Response("Internal Server Error", { status: 500 });
      };
    },
    ...handlers,
    finalHandler
  ]);
}
function wrap(handler) {
  return async (context) => {
    let result;
    try {
      result = await (handler(context) || context.next());
    } catch (error) {
      if (error instanceof Response) {
        return error;
      } else if (isResponseConvertible(error)) {
        return error.toResponse();
      } else if (context.handleError) {
        return context.handleError(error);
      } else {
        throw error;
      }
    }
    if (isResponseConvertible(result)) {
      return result.toResponse();
    }
    return result;
  };
}
function isResponseConvertible(response) {
  return response && "toResponse" in response;
}
export {
  compose,
  composePartial
};
